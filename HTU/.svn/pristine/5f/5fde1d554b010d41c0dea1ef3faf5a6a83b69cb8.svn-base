<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>

<style>
  .jstree-search {
	/* js트리는 search를 이용해 찾은 요소에 italic이 적용돼있는데 구려서 적용해제시킴 */
/*   		font-style: normal !important; */
  		/* 일단 예시로 빨간색을 줘봤는데 알아서 바꾸세용 */
  		color: #333333;
   }
  .keyword{border:1px solid #888888; width:180px; font-size:13px; padding:5px;}
  .registModal input {
    font-size: 14px;
    width: 120px;
    margin-left: 5px;
    display: inline-block;
    color: #000 !important;
  }

  .registModal .input_width {
    width: 170px;
  }

  .registModal .input_border {
    border-right: 1px solid #ebebeb;
  }

  .registModal input:focus {
    outline: none;
  }

  .registModal td {
    display: flex;
    border: 1px solid #ebebeb;
    box-sizing: border-box;
    height: 30px;
  }

  .registModal .th_span {
    font-size: 13px;
    box-sizing: border-box;
    padding: 10px;
    color: #555;
    border-right: 1px solid #ebebeb;
    display: inline-block;
    width: 90px;
    height: 100%;
    text-wrap: nowrap;
  }
  
  .registModal .table_topic {
      font-size: 20px;
      padding-bottom: 30px;
  }

  .registModal .table_topic i {
      margin-left: 10px;
  }

  .close_bt:hover {
    background-color: #333;
  }

  select[readonly] {
    pointer-events: none;
  }

  select {
    width: 120px;
    margin-left: 5px;
    padding: 3px;
    border: none;
    font-size: 14px;
    -webkit-appearance: none;
    /* 크롬 화살표 없애기 */
    -moz-appearance: none;
    /* 파이어폭스 화살표 없애기 */
    appearance: none;
    /* 화살표 없애기 */
    text-align-last: center;
    text-align: center;
  }
  /* input number 화살표 없애기 */
  input[type="number"]::-webkit-outer-spin-button, 
  input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
</style>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<sec:authentication property="principal.userVO" var="vo"/>
<div class="sub_menu">
	<div class="sub_title">학생관리</div>
	<button class="sub_button" id="registStudentBtn">
		<a class="sub_text" href="#none">학생등록</a>
	</button>
	<input type="text" placeholder="검색어를 입력하세요." name="keyword" id="keyword" class="keyword">
	<div id="tree"></div>
	<div class="submenu_menu">
	<a href="#none" class="sub_menu_a">장학금조회</a>
	<a href="#none" class="sub_menu_a">성적조회</a>
	</div>
</div>

<input type="file" id="excelUpload">


<div class="registModal" style="display: none;">
  <div class="reg-modal-bg" style="position: fixed; z-index: 998; top: 0; left: 0; background: rgba(0, 0, 0, 0.4); width: 100%; height: 100%; overflow-y: hidden;"></div>
  <div class="registModal" style="position: absolute; padding: 30px; padding-top: 60px; z-index: 999; width: 800px; height: 600px; background: #ffffff; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <button type="button" class="btn-two gray mini close_bt" onclick="closeRegistModal()" style="padding:5px 10px; margin-bottom:20px; margin-right: 0; position:fixed; z-index: 999; right: 30px; top:20px; transition:.3s;">닫기 <i class="fa-solid fa-xmark" style="color: #ffffff;"></i></button>
    <div style="height:100%; width:100%; overflow-y: scroll;">
      <div class="table_topic">사용자 정보 등록</div>
      <div style="font-size:15px; padding-bottom:10px; display:flex; align-items:center;">
        <svg xmlns="http://www.w3.org/2000/svg" height="18" width="18" viewBox="0 0 512 512"><path fill="#751c35" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>
        <span style="margin-left:5px;">인적정보</span>
      </div>
      <div style="display:flex;">
        <div class="registFilehover">
          <img src="/resources/images/unknownperson.jpg" style="min-width:145px; max-width:145px; height:180px; object-fit: cover;" id="registFile" class="registFile"/>
        </div>
        <table>
          <tr>
            <td>
              <div class="th_span">이름</div>
              <input required id="regUserNm" name="regUserNm" type="text" />
            </td>
            <td>
              <div class="th_span">영문이름</div>
              <input required id="regUserNme" name="regUserNme" type="text" />
            </td>
          </tr>
          <tr>
            <td>
              <div class="th_span">주민등록번호</div>
              <div style="display: flex; align-items: center;">
                <input type="text" id="regUserReg1">
                <span>-</span>
                <input type="password" id="regUserReg2">
              </div>
            </td>
            <td>
              <div class="th_span">전화번호</div>
              <input type="number" id="regUserTel">
            </td>
            <td>
              <div class="th_span">메일</div>
              <div id="mailBox" style="display: flex; align-items: center;">
                <input type="text" id="regUserMail">
                <span>@</span>
                <select id="selectMail">
                  <option value="">--</option>
                  <option value="1">직접입력</option>
                  <option value="2">naver.com</option>
                  <option value="3">daum.net</option>
                </select>
              </div>
            </td>
            <td>
              <div class="th_span">사용자구분</div>
              <select id="regComdCd">
                <option value="USER01">학생</option>
                <option value="USER02">교수</option>
                <option value="USER03">학사관리자</option>
              </select>
            </td>
          </tr>
        </table>
        
      </div>
      <table>
        <tr>
          <td>
            <div style="display: flex; align-items: center;">
              <div class="th_span">우편번호</div>
              <input type="text" id="zipCode">
              <button class="btn-two mini green" onclick="sample6_execDaumPostcode()">주소검색</button>
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <div class="th_span">주소</div>
            <input type="text" id="address">
          </td>
          <td>
            <div class="th_span">상세주소</div>
            <input type="text" id="address2">
            <input type="text" id="address3" style="display: none;">
          </td>
        </tr>
        <tr>
          <td>
            <div class="th_span">은행명</div>
            <input type="text" id="regUserBank">
            <div class="th_span">예금주</div>
            <input type="text" id="regUserDepo">
          </td>
        </tr>
        <tr>
          <td>
            <div class="th_span">계좌번호</div>
            <input type="text" id="regUserAcc">
          </td>
        </tr>
      </table>
      <div style="font-size:15px; padding-bottom:10px; display:flex; align-items:center; margin-top: 40px;">
        <svg xmlns="http://www.w3.org/2000/svg" height="18" width="18" viewBox="0 0 512 512"><path fill="#751c35" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>
        <span style="margin-left:5px;">학적정보</span>
      </div>
      <table>
        <tr>
          <td>
            <div class="th_span">단과대학</div>
            <select id="regComdCd">
              <c:forEach items="${coleCommonList}" var="collegeVO">
                <c:if test="${collegeVO.comdCd != 'COLE09' and collegeVO.comdCd != 'COLE10'}">
                  <option value="${collegeVO.comdCd}">${collegeVO.comdNm}</option>
                </c:if>
              </c:forEach>
            </select>
            <div class="th_span">전공학과</div>
            <select name="" id="">
              
            </select>
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>


<script>
  
  function closeRegistModal() {
    $(".registModal").hide();
  }
  
  $(".reg-modal-bg").on("click", function() {
    closeRegistModal();
  })
  
  $("#selectMail").on("change", function() {
    const result = $(this).val()
    if (result == 1) {
      $(this).remove();
      $("#mailBox").append($("<input type='text' id='regUserMail2'>"));
    }
  })
  
  // 학생등록 여부 확인
  $("#registStudentBtn").on("click", function() {
    Swal.fire({
      title: "학생등록",
      icon: "question",
      /* warning,error,success,info,question */
      width: 600,
      /* padding: "4em", */
      position: "top",
      showCancelButton: true,
      showDenyButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#555555",
      denyButtonColor:"#A1EEBD",
      confirmButtonText: "개별등록",
      cancelButtonText: "뒤로가기",
      denyButtonText: "일괄등록",
      /* reverseButtons: true, */ // 버튼 순서 거꾸로
    }).then((result) => {
      console.log(result);
      if(result.isConfirmed){
        // 개별등록 모달 꾸미기
        $(".registModal").show();
      }
      else if(result.isDenied){
        $("#excelUpload").click();
      }
    });
  });
  
  $("#excelUpload").on("change", function() {
    const formData = new FormData();
    formData.append("file", $("#excelUpload")[0].files[0]);
    
    $.ajax({
      url: "/employee/stuadmin/excelUpload",
      type: "post",
      contentType: false,
      processData: false,
      data: formData,
      beforeSend: function (xhr) {
        xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
      },
      success: res => {
        if (res == "") {
          alertError("확장자가 .xlsx인 엑셀 파일을 첨부해주세요.")
        } else {
          const cnt = res.stuCoc / 2;
          $("#"+res.depCd.substr(0,6)+"_anchor").dblclick();
          $("#"+res.depCd+"_anchor").click();
          alertSuccess(cnt + "명의 학생이 등록되었습니다.")
        }
      },
      error: xhr => {
        console.log(xhr);
        
      }
    })
  })
  
  // 주소 api
  function sample6_execDaumPostcode() {
    new daum.Postcode({
      oncomplete: function (data) {
        // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

        // 각 주소의 노출 규칙에 따라 주소를 조합한다.
        // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
        var addr = ""; // 주소 변수
        var extraAddr = ""; // 참고항목 변수

        //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
        if (data.userSelectedType === "R") {
          // 사용자가 도로명 주소를 선택했을 경우
          addr = data.roadAddress;
        } else {
          // 사용자가 지번 주소를 선택했을 경우(J)
          addr = data.jibunAddress;
        }

        // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
        if (data.userSelectedType === "R") {
          // 법정동명이 있을 경우 추가한다. (법정리는 제외)
          // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
          if (data.bname !== "" && /[동|로|가]$/g.test(data.bname)) {
            extraAddr += data.bname;
          }
          // 건물명이 있고, 공동주택일 경우 추가한다.
          if (data.buildingName !== "" && data.apartment === "Y") {
            extraAddr +=
              extraAddr !== "" ? ", " + data.buildingName : data.buildingName;
          }
          // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
          if (extraAddr !== "") {
            extraAddr = " (" + extraAddr + ")";
          }
          // 조합된 참고항목을 해당 필드에 넣는다.
          document.getElementById("address3").value = extraAddr;
        } else {
          document.getElementById("address3").value = "";
        }

        // 우편번호와 주소 정보를 해당 필드에 넣는다.
        document.getElementById("zipCode").value = data.zonecode;
        document.getElementById("address").value = addr;
        // 커서를 상세주소 필드로 이동한다.
        document.getElementById("address2").focus();
      },
    }).open();
  }
</script>
