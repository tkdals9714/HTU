<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<script src="/resources/js/jquery.min.js"></script>
<style>
/* 공통 스타일 */
.text-center {
	text-align: center;
}

/* 카드 스타일 */
.card-body {
	width: 60%;
	height: 10%;
}

.card .topic {
	position: relative;
	padding-top: 30px;
}

.free_topic {
	font-size: 30px;
	padding-bottom: 30px;
}

.FreeBoard_box .free_topic i {
	margin-left: 10px;
	color: #333333; /* 추가된 부분 */
}

.FreeBoard_box table {
	font-size: 14px;
	width: 168%;
}

.FreeBoard_box table tbody tr {
/*     cursor: pointer; */
}

.FreeBoard_box table tbody tr td:nth-child(2) {
    text-align: left; /* 두 번째 열(제목)만 왼쪽 정렬 */
}

.FreeBoard_box table tbody tr td:not(:nth-child(2)) {
    text-align: center; /* 나머지는 가운데 정렬 */
}

/* Optional: If you want to center text in the first column vertically */
.FreeBoard_box table tbody tr td:nth-child(2) {
    vertical-align: middle;
}

.FreeBoard_box table tbody tr {
	height: 20px; /* 적절한 높이로 조절해주세요 */
	line-height: 20px; /* 적절한 높이로 조절해주세요 */
}

.table_title {
	font-size: 13px;
	border: 1px solid #d1d0d0;
	height: 32px;
	line-height: 32px;
	background-color: #f8f9fa;
	font-weight: bold; /* 글씨 굵게 */
}


.FreeBoard_box table tbody tr td:first-child {
    font-weight: bold;
}

/* 글쓰기 링크 스타일 */
.write-link {
	position: absolute;
	top: 50%;
	left: 80%;
}
</style>


<div class="FreeBoard_box" style="background-color: white;">
	<input type="text" id="vo" style="display: none;" value='${lecture}'>
	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<br><br>
				<div class="topic">
					<br><br><br>
					<div class="free_topic" style="position: absolute; left: 3%; top: 38%;">
						출결 관리
						<i class="fa-solid fa-circle-info" style="position: absolute; top: 1px;"></i>
					</div>
				</div>
				<div class="card-body">
					<div id="bootstrap-data-table_wrapper"
						class="dataTables_wrapper container-fluid dt-bootstrap4 no-footer">
						<div class="row">
							<div class="col-sm-12">
								<table id="bootstrap-data-table"
									class="table table-striped table-bordered dataTable no-footer"
									role="grid" aria-describedby="bootstrap-data-table_info">
									<thead>
										<c:set value="${fn:length(fn:split(lectureVO.lectureScheduleVO.lecDay, '/'))}" var="daySize"/>
										<c:choose>
											<c:when test="${daySize == 1}">
												<c:set value="${fn:length(lectureVO.calendarList)}" var="span" />											
											</c:when>
											<c:when test="${daySize == 2}">
												<c:choose>
													<c:when test="${fn:length(lectureVO.calendarList) % 2 == 0}">
														<c:set value="${fn:length(lectureVO.calendarList) / 2}" var="span" />
													</c:when>
													<c:otherwise>
														<c:set  value="${(fn:length(lectureVO.calendarList) / 2) + 0.5}" var="span"/>
													</c:otherwise>
												</c:choose>
											</c:when>
										</c:choose>
										<tr role="row" class="table_title">
											<th class="text-center" colspan="${span + 3}" id="lectureNm" style="position: relative;">
												<div style="font-size: 18px; font-weight: 600;">${lectureVO.lectureApplyVO.lecaNm}</div> 
												<div style="display: flex; align-items: center; position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">
													<div style="display: flex; align-items: center;  margin-right: 8px;">
														<div style="color: #03c75a; margin-top: -2px; margin-right: 3px;">○</div>  : 출석
													</div>
													<div style="display: flex; align-items: center;  margin-right: 3px;">
														<div style="color: #39A7FF; margin-right: 3px;">△</div>  : 지각
													</div>
													<div style="display: flex; align-items: center; "> 
														<div style="color: #ff2929; font-size: 18px; margin-top: -4px; margin-right: 3px;">×</div>  : 결석
													</div>
												</div>
											</th>
										</tr>
										<tr role="row" class="table_title text-center">
											<th width="150px;" class="text-center"><b>학생</b></th>
											<c:set value="${fn:split(lectureVO.lectureScheduleVO.lecDay, '/')}" var="dayArr"/>
											<th class="text-center" width="50px;">요일</th>
											<c:forEach begin="0" end="${span - 1}" var="i">
												<th style=""><b>${i+1}주차</b></th>
											</c:forEach>
											<th>비고</th>
										</tr>
									</thead>
									<tbody>
										<c:forEach items="${lectureVO.studentList}" var="studentVO">
<!-- 											<tr role="row" class="odd" style="cursor: pointer;"> -->
											<tr role="row" class="odd" style="border-bottom: 1px solid #f2f3f4;">
												<td style="padding-right: 2px; display: flex; align-items: center; height: 100px;" class="text-center" >
<%-- 													<img style="width: 80px; height: 80px; display: inline-block; margin-right: 5px;" src="/resources/upload/${studentVO.filesDetailVO.fileSvnm}" alt=""> --%>
													<div style="width: 60px; height: 80px; position: relative; overflow: hidden; margin-right: 10px;">
														<img src="/resources/upload/${studentVO.filesDetailVO.fileSvnm}" style="width: 100px; height: 100px;  object-fit: contain; display:inline; position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);">
													</div>
													<div style="text-align: left;">
														<div>${studentVO.stuCd}</div>
														<div>${studentVO.userVO.userNm}</div>
														<div>${studentVO.departmentVO.depNm}</div>
													</div>
												</td>
												<c:set value="${fn:length(lectureVO.calendarList)}" var="orginSize"/>
												<c:choose>
													<c:when test="${daySize == 1}">
														<c:forEach begin="0" end="${orginSize}" var="i">
															<td class="text-center">
																check
															</td>
														</c:forEach>
													<td>1/1</td>
													</c:when>
													<c:when test="${daySize == 2}">
														<td class="text-center" style="height: 100px;">
															<div style="height: 40px; line-height: 30px;">${fn:substring(dayArr[0],0,1)}</div>
															<div style="height: 40px; line-height: 50px;">${fn:substring(dayArr[1],0,1)}</div>
														</td>
														<c:forEach begin="0" end="${orginSize}" var="i" step="2">
															<td style="height: 100px; padding:0;">
																<div style="height: 40px; line-height: 30px; border-bottom: 1px solid #d1d0d0; cursor:pointer; font-weight: bold;" class="insertAtt" data-form-date="${lectureVO.calendarList[i].formDate}" data-stu-cd="${studentVO.stuCd}">
																	<c:if test="${lectureVO.calendarList[i].formDate eq studentVO.attendanceList[i].formDate}">
																		<c:choose>
																			<c:when test="${studentVO.attendanceList[i].attYn eq 0}">
																				<div style="color: #03c75a;">○</div>
<!-- 																				<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 448 512"><path fill="#03c75a" d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg> -->
																			</c:when>	
																			<c:when test="${studentVO.attendanceList[i].attYn eq 1}">
																				<div style="color: #ff2929; font-size: 22px;">×</div>
<!-- 																				<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 384 512"><path fill="#ff2929" d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg> -->
																			</c:when>	
																			<c:when test="${studentVO.attendanceList[i].attYn eq 2}">
																				<div style="color: #39A7FF;">△</div>
<!-- 																				<i class="fa-solid fa-play fa-rotate-270 fa-xl" style="color: #f9bf1f;"></i> -->
																			</c:when>
																		</c:choose>
																	</c:if>
																</div>
																
																<div style="height: 40px; line-height: 50px; cursor:pointer; font-weight: bold; color: #888888;" class="insertAtt" data-form-date="${lectureVO.calendarList[i+1].formDate}" data-stu-cd="${studentVO.stuCd}">
																	<c:if test="${lectureVO.calendarList[i+1].formDate eq studentVO.attendanceList[i+1].formDate}">
																		<c:choose>
																			<c:when test="${studentVO.attendanceList[i+1].attYn eq 0}">
																				<div style="color: #03c75a;">○</div>
<!-- 																				<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 448 512"><path fill="#03c75a" d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg> -->
																			</c:when>	
																			<c:when test="${studentVO.attendanceList[i+1].attYn eq 1}">
																				<div style="color: #ff2929; font-size: 22px;">×</div>
<!-- 																				<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 384 512"><path fill="#ff2929" d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg> -->
																			</c:when>	
																			<c:when test="${studentVO.attendanceList[i+1].attYn eq 2}">
																				<div style="color: #39A7FF;">△</div>
<!-- 																				<i class="fa-solid fa-play fa-rotate-270 fa-xl" style="color: #f9bf1f;"></i> -->
																			</c:when>
																		</c:choose>
																	</c:if>
																</div>
															</td>
														</c:forEach>
													<td>1/1</td>
													</c:when>
												</c:choose>
											</tr>
										</c:forEach>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<script>
	
	$(function() {
		
		const attendance = JSON.parse($("#vo").val());
		
		console.log(attendance);
		
		let formDate = "";
		let stuCd = "";
		
		function insertAttendance() {
			$(".insertAtt").off("click");
			formDate = $(this).data("formDate");
			stuCd = $(this).data("stuCd");
			console.log("formDate = " + formDate + ",  stuCd = " + stuCd);
			
			const childrenNode = $(this).children()[0];
			
			console.log("childrenNode =>", childrenNode);
			
			if (childrenNode != undefined) {
				const tagName = childrenNode.tagName;
				
				console.log("tagName ==> ", tagName);
				
				if (tagName == 'SELECT') {
					return;
				};
				
				if (tagName == 'DIV') {
					Swal.fire({
					title: "출결을 수정하시겠습니까?",
					icon: "question",
					width: 500,
					position: "top",
					showCancelButton: true,
					confirmButtonColor: "#3085d6",
					cancelButtonColor: "#555555",
					confirmButtonText: "수정",
					cancelButtonText: "취소",
				}).then((result) => {
					if (result.isConfirmed) {
						$(this).html(`
							<select id="attUpdate" style="text-align: center;">
								<option value="">-</option>
								<option value="0">○</option>
								<option value="2">△</option>
								<option value="1">X</option>
							</select>
						`)
					}
				});
					return;
				}
			}
			$(this).html(`
				<select id="attYn" style="text-align: center;">
					<option value="">-</option>
					<option value="0">○</option>
					<option value="2">△</option>
					<option value="1">X</option>
				</select>
			`)
			let selectedNode = $(`div[data-form-date='\${formDate}']`);
			console.log(selectedNode);
		}
		
		$(".insertAtt").on("click", insertAttendance)
		
		$(document).on("change", "#attUpdate", function() {
			const attYn = $(this).val();
			
			$.ajax({
				url: "/professor/lectureAttendance/update",
				contentType: "application/json; charset=UTF-8",
				data: JSON.stringify({
					attDt : formDate,
					stuCd : stuCd,
					attYn : attYn,
					lecsCd : attendance.lectureScheduleVO.lecsCd
				}),
				type: "post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success : res => {
					console.log(res);
				},
				error: xhr => {
					console.log(xhr);
				}
			})
		})
		
		$(document).on("change", "#attYn", function() {
			const attYn = $(this).val();
			
			$.ajax({
				
				url: "/professor/lectureAttendance/insert",
				contentType: "application/json; charset=UTF-8",
				data: JSON.stringify({
					attDt : formDate,
					stuCd : stuCd,
					attYn : attYn,
					lecsCd : attendance.lectureScheduleVO.lecsCd
				}),
				type: "post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success: res => {
					if (res == 1) {
						let txt = '';
						if (attYn == 0) txt = `<div style="color: #03c75a;">○</div>`
						else if (attYn == 1) txt = `<div style="color: #ff2929; font-size: 22px;">×</div>`
						else if (attYn == 2) txt = `<div style="color: #39A7FF;">△</div>`
						$(this).parent().html(txt);
						$(".insertAtt").on("click", insertAttendance);
					}
				},
				error: xhr => {
					console.log(xhr);
				}
			})
		})
	})
</script>