<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.SchlshipMapper">
	
	<resultMap type="schlshipVO" id="schlMap">
		<result property="sclCd" column="SCL_CD"/>
		<result property="stuCd" column="STU_CD"/>
		<result property="siCd" column="SI_CD"/>
		<result property="sclYear" column="SCL_YEAR"/>
		<result property="sclSem" column="SCL_SEM"/>
	</resultMap>
	
	<resultMap type="studentVO" id="stuMap">
		<result property="stuCd" column="STU_CD"/>
		<result property="depCd" column="DEP_CD"/>
		<result property="comdCd" column="COMD_CD"/>
		<result property="stuYear" column="STU_YEAR"/>
		<result property="stuSem" column="STU_SEM"/>
		<result property="stuMrc" column="STU_MRC"/>
		<result property="stuMoc" column="STU_MOC"/>
		<result property="stuCrc" column="STU_CRC"/>
		<result property="stuCoc" column="STU_COC"/>
		<result property="stuAddt" column="STU_ADDT"/>
		<result property="stuGrdt" column="STU_GRDT"/>
		<result property="comdNm" column="COMD_NM"/>
		<result property="depNm" column="DEP_NM"/>
		<result property="stuNm" column="STU_NM"/>
		<result property="score" column="SCORE"/>
		<result property="rank" column="RANK"/>
		<result property="depFee" column="DEP_FEE"/>
	</resultMap>
	
	<select id="awardSchlship" resultMap="stuMap">
		WITH ALLRANK AS (
		    SELECT
		        COMD_NM, DEP_NM, STU_NM, STU_CD, STU_YEAR, AVG(SCORE) SCORE,
		        RANK() OVER (PARTITION BY DEP_NM, STU_YEAR ORDER BY AVG(SCORE) DESC) RANK,
		        DEP_FEE
		    FROM (
		        SELECT G.COMD_NM, D.DEP_NM, D.DEP_FEE, A.STU_CD, E.USER_NM STU_NM, F.STU_YEAR, C.LECA_YEAR, C.LECA_SEM
		       , CASE
		            WHEN LECG_SUM >= 97 THEN 4.5
		            WHEN LECG_SUM >= 93 THEN 4.3
		            WHEN LECG_SUM >= 90 THEN 4.0
		            WHEN LECG_SUM >= 87 THEN 3.7
		            WHEN LECG_SUM >= 83 THEN 3.5
		            WHEN LECG_SUM >= 80 THEN 3.3
		            WHEN LECG_SUM >= 77 THEN 3.0
		            WHEN LECG_SUM >= 75 THEN 2.5
		            WHEN LECG_SUM >= 70 THEN 2.0
		            WHEN LECG_SUM >= 65 THEN 1.5
		            WHEN LECG_SUM >= 60 THEN 1
		            ELSE 0
		        END SCORE
		        FROM
		            LECTURE_GRADE A, GRADE_CRITERIA B, LECTURE_APPLY C,DEPARTMENT D
		            , USERS E, STUDENT F, COMMON_DETAIL G
		        WHERE
		            A.CRTR_CD = B.CRTR_CD
		            AND B.LEC_CD = C.LECA_CD
		            AND C.LECA_YEAR = TO_CHAR(SYSDATE, 'YYYY')
		            AND C.LECA_SEM = 
		                CASE 
		                    WHEN TO_CHAR(SYSDATE, 'MM') &lt; 09 THEN 1
		                    ELSE 2 
		                END
		            AND A.STU_CD = E.USER_CD
		            AND F.DEP_CD = D.DEP_CD
		            AND F.STU_CD = E.USER_CD
		            AND D.COL_CD = G.COMD_CD
		    )
		    GROUP BY STU_CD, DEP_NM, STU_NM, COMD_NM, STU_YEAR, DEP_FEE
		)
		SELECT * FROM ALLRANK
		WHERE RANK &lt;= 3
	</select>
	
	
	
</mapper>