<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<!-- <script src="/resources/js/jquery.min.js"></script> -->
<style>
	#rtnModal {
	  position:absolute; 
	  width:100%; 
	  height:100%; 
	  background: rgba(0,0,0,0.4); 
	  top:0; 
	  left:0; 
	  display:none;
	}
	.rtnModal-content {
	  background-color: #fefefe;
	  margin: 15% auto;
	  padding: 20px;
	  width: 40%;
	  height: 60%;
	}
	#rtnBtn, #closeBtn {
	  float: right;
	}
	.rtnReason {
	  padding: 10px;
	}
	#appRet {
	  width: 100%;
	  height: 80%;
	  font-size: 15px;
	  border: 0;
	  border-radius: 15px;
	  outline: none;
	  padding: 15px;
	  background-color: rgb(233, 233, 233);
	  resize: none;
	}
	.crewHeaderName {
	  font-size: 40px; 
	  padding-bottom: 30px;
	}
	.crewDivbox {
	  width: 100%;
	  display: inline-flex;
	}
	.crewDiv1 {
	  width: 40%;
	  margin-right: 10px;
	}
	.crewDiv2 {
	  width: 60%;
	}
	.crewInfo {
	  border-radius : 5px;
	  padding: 15px 20px;
	  margin-bottom: 10px;
	  background-color: #ffffff;
	  overflow: auto;
	}
	.crewInfoCon-title {
	  padding-right: 5px;
	}
	.crewModBtn {
	  width: 20px;
	  height: 20px;
	  float: right;
	}
	.crewManage {
	  border-radius : 5px;
	  padding: 15px 13px;
	  background-color: #ffffff;
	  overflow: auto;
	}
	.crewPerson {
	  border-radius : 5px;
	  height: 100%;
	  padding: 15px 20px;
	  margin-bottom: 10px;
	  background-color: #ffffff;
	  overflow: auto;
	}
	.crewPersonHeader {
	  font-size: 24px; 
	}
	.crewPerconTbl {
	  width: 100%;
	  height: 100%;
	  text-align: center;
	}
	.crewPerconTbl th {
    position: sticky;
    top: 0px;
	}
	.crewPerson-tr{
	  border-top: 1px solid #eaeaea;
	}
	.crewActivity {
	  font-size: 24px; 
	  padding-top: 30px;
	}
	.crewAct {
	  width: 80%; 
	  border-bottom: 1px solid gray;
	  padding: 20px 0 20px 0;
	}
	.actStuNm {
	  font-size: 18px; 
	  font-weight: bold;
	}
	.crewAct p {
		padding: 10px 0;
	}
</style>
<sec:authentication property="principal.userVO" var="userVO"/>
<input id="crCd" value="${crewVO.crCd}" hidden />
<!-- 반려 사유 모달 -->
<div id="rtnModal">
	<div class="rtnModal-content">
		<p class="rtnReason">반려 사유</p>
		<textarea id="appRet" maxlength=333 required="required"></textarea>
		<div>
			<button type="button" class="btn-two red mini" id="rtnBtn">확인</button>
			<button type="button" class="btn-two gray mini" id="closeBtn">닫기</button>
		</div>
	</div>
</div>

<div class="crewHeaderName">
	${crewVO.crNm}
</div>

<div class="crewDivbox">
	<div class="crewDiv1">
		<div class="crewInfo">
			<table class="crewInfoCon">
				<tr>
					<td class="crewInfoCon-title">회장</td>
					<td>${crewVO.ldrNm}</td>
				</tr>
				<tr>
					<td class="crewInfoCon-title">동아리실</td>
					<td>학생회관 ${crewVO.roomNm}</td>
				</tr>
<!-- 				<tr> -->
<!-- 					<td> -->
<%-- 						<c:forEach var="fileDetail" items="${crewVO.filesDetailVOList}"> --%>
<%-- 			        		<a href="/resources/upload/${fileDetail.fileSvnm}" download="${fileDetail.fileOrnm}"> --%>
<%-- 								<img alt="" src="/resources/upload/${fileDetail.fileSvnm}" style="width: 100px; height: 100px;"> --%>
<!-- 							</a><br> -->
<%-- 			    		</c:forEach> --%>
<!-- 			    	</td> -->
<!-- 				</tr> -->
			</table>
			<c:if test="${crewVO.crLeader eq userVO.userCd}">
				<div>
					<a href="/student/crew/crewUpdate?crCd=${crewVO.crCd}">
						<img class="crewModBtn" src="/resources/images/gear.png" alt="crewManage" />
					</a>
				</div>
			</c:if>
		</div>
		<c:if test="${crewVO.crLeader eq userVO.userCd}">
			<div class="crewManage">
				<div>
					<p>동아리 가입 신청</p>
				</div>
				<c:forEach var="approvalVO" items="${approvalVOList}">
				    <div>
				        ${approvalVO.stuNm}
			            <button type="button" class="btnApp btn-two sky mini" data-app-cd="${approvalVO.appCd}" data-user-cd="${approvalVO.approvalVO.userCd}">승인</button>
			            <button type="button" class="btnRtn btn-two red mini" data-app-cd="${approvalVO.appCd}" data-user-cd="${approvalVO.approvalVO.userCd}">반려</button>
					<c:if test="${approvalVOList eq null}">
						<p style="color: #eeeeee;">확인하지 않은 가입 신청이 없습니다.</p>
					</c:if>
				    </div>
				</c:forEach>
			</div>
		</c:if>
	</div>
	<div class="crewDiv2">
		<div class="crewPerson">
		<p>흥</p>
			<table class="crewPerconTbl">
				<tr>
					<th style="width: 10%">번호</th>
					<th style="width: 10%">학번</th>
					<th style="width: 40%">학과</th>
					<th style="width: 30%">이름</th>
				</tr>
				<c:forEach var="crewPerson" items="${crewPersonnelList}" varStatus="stat">
					<tr class="crewPerson-tr">
						<td style="width: 10%">${stat.count}</td>
						<td style="width: 10%">${crewPerson.stuCd}</td>
						<td style="width: 40%">통계학과</td>
						<td style="width: 30%">${crewPerson.stuNm}</td>
					</tr>
				</c:forEach>
			</table>
		</div>
	</div>
</div>
	<c:if test="${crewVO.crLeader ne userVO.userCd}">
		<c:choose>
		    <c:when test="${crVO ne null and not empty crVO}">
                <button type="button" id="btnQuit" class="btn-two red mini">탈퇴</button>
		    </c:when>
		    <c:otherwise>
            	<button type="button" id="btnApply" data-stu-cd="${crewVO.stuCd}" class="btn-two red mini">가입</button>
		    </c:otherwise>
		</c:choose>
	</c:if>
	
<div>
	<c:if test="${crVO ne null and not empty crVO}">
		<div class="crewActivity">
			동아리 활동
		</div>
		<c:forEach var="actVO" items="${crewActVOList}"> 
			<div class="crewAct">
				<p class="actStuNm">${actVO.stuNm}</p>
				<p>${actVO.craCon}</p>
				<p><fmt:formatDate value="${actVO.craStdt}" pattern="yyyy년 MM월 dd일 HH시 mm분"/> - 
				<fmt:formatDate value="${actVO.craEddt}" pattern="yyyy년 MM월 dd일 HH시 mm분"/></p>
			</div>
		</c:forEach>
	</c:if>
</div>

<script>
$(function(){
	
	//승인 버튼 클릭 시
	$(".btnApp").on("click", function(){
		let appCd = $(this).data("appCd");
		let userCd = $(this).data("userCd");
        let crCd = "${crewVO.crCd}";
        
		$.ajax({
			url:"/student/crew/crewJoinApp",
			data:{
				appYn : 1,
				appCd : appCd,
				userCd : userCd,
				crCd : crCd
			},
			type:"post",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success:function(res){
				alertSuccess('승인되었습니다.', '/student/crew/crewDetail?crCd='+crCd);
			}
		});
	});
	
	//반려 버튼 클릭 시
	$(".btnRtn").on("click", function(){
		let appCd = $(this).data("appCd");
		let userCd = $(this).data("userCd");
		let crCd = "${crewVO.crCd}";

        $("#rtnModal").fadeIn();

        $("#closeBtn").on("click", function(){
        	$("#rtnModal").fadeOut();
        });
        
        $("#rtnBtn").on("click", function(){
	        let appRet = $("#appRet").val();
	        
	        console.log("appRet: " + appRet);
	        
            $.ajax({
                url: "/student/crew/crewReturn",
                data: {
                    appYn: 2,
                    appCd : appCd,
                    userCd: userCd,
                    crCd: crCd,
                    appRet: appRet
                },
                type: "post",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
                },
                success: function(res) {
		            $("#rtnModal").modal("hide");
                    alertSuccess('반려 처리되었습니다.', '/student/crew/crewDetail?crCd='+crCd);
                }
            });
        });
    });
	
	$("#btnApply").on("click", function(){
		console.log("ddd");
		let stuCd = "${userVO.userCd}";
		let crCd = $("#crCd").val();
		let crLeader = "${crewVO.crLeader}";
		
		console.log("stuCd : " + stuCd);
		console.log("crCd : " + crCd);
		console.log("crLeader : " + crLeader);
		
		if(confirm("가입하시겠습니까?")){
			
			$.ajax({
				url:"/student/crew/crewJoin",
				data:{
					stuCd: stuCd,
					crCd: crCd,
					crLeader: crLeader
				},
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					if(res == null){
						alertError('이미 신청하였습니다.', '/student/crew/crewDetail?crCd='+crCd);
					}else{
						alertSuccess('신청되었습니다.', '/student/crew/crewDetail?crCd='+crCd);
					}
				}
			});
		}
	});
	
	$("#btnQuit").on("click", function(){
		let stuCd = "${userVO.userCd}";
		let crCd = $("#crCd").val();
		
		console.log("stuCd : " + stuCd);
		console.log("crCd : " + crCd);
		
		if(confirm("탈퇴하시겠습니까?")){
			
			$.ajax({
				url:"/student/crew/crewQuit",
				data:{
					stuCd:stuCd,
					crCd:crCd
				},
				type:"post",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					alertSuccess('정상적으로 탈퇴 처리되었습니다.', '/student/crew/myCrew');
				}
			});
		}
	});
});
</script>